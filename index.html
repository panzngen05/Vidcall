<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Panz Chat</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{font-family:sans-serif;background:#0f172a;color:white;margin:0}
#login,#chat{padding:15px}
input,button{padding:10px;border:none;border-radius:8px}
button{background:#22c55e;color:white}
#messages{height:60vh;overflow:auto;background:#020617;padding:10px;border-radius:10px}
.msg{margin:5px 0;padding:8px;background:#1e293b;border-radius:8px}
img{max-width:150px;border-radius:10px}
</style>
</head>
<body>

<div id="login">
<h2>Panz Chat Login</h2>
<input id="name" placeholder="Nama kamu"><br><br>
<button onclick="login()">Masuk</button>
</div>

<div id="chat" style="display:none">
<h3>Global Room</h3>
<div id="messages"></div><br>
<input id="text" placeholder="Ketik pesan">
<input type="file" id="file">
<button onclick="send()">Kirim</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } 
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";

/* FIREBASE CONFIG KAMU */
const firebaseConfig = {
  apiKey: "AIzaSyCF6VsawNScXC8vQuqqFtVK9dqnwIiN5Us",
  authDomain: "vidcall-c5202.firebaseapp.com",
  databaseURL: "https://vidcall-c5202-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "vidcall-c5202",
  storageBucket: "vidcall-c5202.firebasestorage.app",
  messagingSenderId: "1088851390418",
  appId: "1:1088851390418:web:cb2a3214ff94435f82e20b"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let username = "";

window.login = function(){
  const n = document.getElementById("name").value;
  if(!n) return alert("Isi nama dulu");
  username = n;
  document.getElementById("login").style.display="none";
  document.getElementById("chat").style.display="block";
}

/* LISTEN REALTIME MESSAGE */
const q = query(collection(db,"messages"), orderBy("time"));
onSnapshot(q,(snap)=>{
  const box = document.getElementById("messages");
  box.innerHTML="";
  snap.forEach(doc=>{
    const d = doc.data();
    box.innerHTML += `
      <div class="msg">
        <b>${d.user}</b><br>
        ${d.text||""}
        ${d.img?`<br><img src="${d.img}">`:""}
      </div>`;
  });
  box.scrollTop = box.scrollHeight;
});

/* SEND MESSAGE */
window.send = async function(){
  const text = document.getElementById("text").value;
  const file = document.getElementById("file").files[0];
  let imgUrl = "";

  if(file){
    const storageRef = ref(storage,"chat/"+Date.now());
    await uploadBytes(storageRef,file);
    imgUrl = await getDownloadURL(storageRef);
  }

  if(!text && !imgUrl) return;

  await addDoc(collection(db,"messages"),{
    user: username,
    text: text,
    img: imgUrl,
    time: serverTimestamp()
  });

  document.getElementById("text").value="";
  document.getElementById("file").value="";
}
</script>
</body>
</html>
