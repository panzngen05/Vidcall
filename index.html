<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Panz Chat Pro</title>
<style>
body{font-family:sans-serif;background:#0f172a;color:white;margin:0}
.box{padding:15px}
input,button{padding:10px;margin:3px;border-radius:8px;border:none}
button{background:#22c55e;color:white}
#users{background:#020617;height:150px;overflow:auto;padding:5px}
.user{padding:5px;background:#1e293b;margin:3px;border-radius:6px;cursor:pointer}
#msgs{background:#020617;height:40vh;overflow:auto;padding:10px}
.msg{background:#1e293b;margin:5px;padding:8px;border-radius:8px}
.top{background:#020617;padding:10px}
</style>
</head>
<body>

<div id="auth" class="box">
<h3>Register / Login</h3>
<input id="username" placeholder="Username"><br>
<input id="password" type="password" placeholder="Password"><br>
<button onclick="authUser()">Masuk / Daftar</button>
</div>

<div id="app" style="display:none">

<div class="top">
<span id="me"></span>
<button onclick="logout()">Logout</button>
</div>

<div class="box">
<h4>Users</h4>
<div id="users"></div>
</div>

<div class="box">
<h4 id="roomTitle">Global Chat</h4>
<div id="msgs"></div>
<input id="text"><button onclick="send()">Kirim</button>
<button onclick="setGlobal()">Global</button>
</div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc,
collection, addDoc, onSnapshot, query, orderBy, serverTimestamp }
from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCF6VsawNScXC8vQuqqFtVK9dqnwIiN5Us",
  authDomain: "vidcall-c5202.firebaseapp.com",
  databaseURL: "https://vidcall-c5202-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "vidcall-c5202",
  storageBucket: "vidcall-c5202.firebasestorage.app",
  messagingSenderId: "1088851390418",
  appId: "1:1088851390418:web:cb2a3214ff94435f82e20b"
};

const appFirebase = initializeApp(firebaseConfig);
const db = getFirestore(appFirebase);

let meUser="";
let currentRoom="global";
let privateTarget="";
let unsub=null;

/* AUTO LOGIN */
window.addEventListener("load", async ()=>{
  const savedUser = localStorage.getItem("panz_user");
  if(savedUser){
    meUser = savedUser;
    auth.style.display="none";
    app.style.display="block";
    me.innerText="Login sebagai: "+meUser;

    await updateDoc(doc(db,"users",meUser),{online:true});
    loadUsers();
    listenGlobal();
  }
});

/* REGISTER / LOGIN */
window.authUser = async ()=>{
  const u=username.value;
  const p=password.value;
  if(!u||!p) return alert("Isi semua");

  const ref=doc(db,"users",u);
  const snap=await getDoc(ref);

  if(!snap.exists()){
    await setDoc(ref,{password:p,online:true,lastSeen:Date.now()});
  } else {
    if(snap.data().password!==p) return alert("Password salah");
    await updateDoc(ref,{online:true});
  }

  meUser=u;
  localStorage.setItem("panz_user", meUser);

  auth.style.display="none";
  app.style.display="block";
  me.innerText="Login sebagai: "+u;

  loadUsers();
  listenGlobal();
}

/* USERS LIST */
function loadUsers(){
  onSnapshot(collection(db,"users"),snap=>{
    users.innerHTML="";
    snap.forEach(d=>{
      const u=d.id;
      const data=d.data();
      if(u===meUser) return;
      users.innerHTML+=`
        <div class="user" onclick="openPrivate('${u}')">
        ${u} ${data.online?"ðŸŸ¢":"âšª"}
        </div>`;
    });
  });
}

/* GLOBAL CHAT */
function listenGlobal(){
  if(unsub) unsub();
  currentRoom="global";
  roomTitle.innerText="Global Chat";

  const q=query(collection(db,"global_messages"),orderBy("time"));
  unsub=onSnapshot(q,snap=>{
    msgs.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      msgs.innerHTML+=`<div class="msg"><b>${m.user}</b><br>${m.text}</div>`;
    });
    msgs.scrollTop=msgs.scrollHeight;
  });
}
window.setGlobal=listenGlobal;

/* PRIVATE CHAT */
window.openPrivate=(u)=>{
  privateTarget=u;
  currentRoom="private";
  roomTitle.innerText="Chat dengan "+u;

  const roomId=[meUser,u].sort().join("_");
  if(unsub) unsub();

  const q=query(collection(db,"private_rooms",roomId,"messages"),orderBy("time"));
  unsub=onSnapshot(q,snap=>{
    msgs.innerHTML="";
    snap.forEach(d=>{
      const m=d.data();
      msgs.innerHTML+=`<div class="msg"><b>${m.user}</b><br>${m.text}</div>`;
    });
    msgs.scrollTop=msgs.scrollHeight;
  });
}

/* SEND */
window.send=async()=>{
  if(!text.value) return;

  if(currentRoom==="global"){
    await addDoc(collection(db,"global_messages"),{
      user:meUser,
      text:text.value,
      time:serverTimestamp()
    });
  } else {
    const roomId=[meUser,privateTarget].sort().join("_");
    await addDoc(collection(db,"private_rooms",roomId,"messages"),{
      user:meUser,
      text:text.value,
      time:serverTimestamp()
    });
  }

  text.value="";
}

/* LOGOUT */
window.logout=async()=>{
  await updateDoc(doc(db,"users",meUser),{
    online:false,
    lastSeen:Date.now()
  });
  localStorage.removeItem("panz_user");
  location.reload();
}
</script>
</body>
</html>
