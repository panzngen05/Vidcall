<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dark Realtime Chat - Fixed</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #3b82f6;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --msg-sent: #2563eb;
            --msg-received: #333333;
            --border-color: #333;
            --online-color: #10b981;
            --offline-color: #6b7280;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text-primary); 
            height: 100vh; 
            width: 100vw;
            overflow: hidden; 
            display: flex; 
            flex-direction: column; 
        }

        /* --- Scrollbar --- */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }

        /* --- Auth Screen --- */
        #auth-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: var(--bg-color); z-index: 1000; 
            display: flex; justify-content: center; align-items: center; 
            padding: 20px; 
        }
        .auth-box { 
            width: 100%; max-width: 400px; background: var(--surface-color); 
            padding: 30px; border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); text-align: center; 
        }
        .auth-box h2 { margin-bottom: 20px; color: var(--primary-color); font-size: 24px; }
        input { 
            width: 100%; padding: 14px; margin: 10px 0; 
            background: #2a2a2a; border: 1px solid var(--border-color); 
            color: white; border-radius: 8px; font-size: 16px; 
        }
        .auth-box button { 
            width: 100%; padding: 14px; margin-top: 15px; 
            background: var(--primary-color); color: white; border: none; 
            border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; 
        }
        .auth-box button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* --- Layout --- */
        #app-screen { 
            display: none; width: 100%; height: 100%; 
            flex-direction: row; position: relative;
        }
        
        #sidebar { 
            width: 320px; background: var(--surface-color); 
            border-right: 1px solid var(--border-color); 
            display: flex; flex-direction: column; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
        }

        .sidebar-header { 
            padding: 15px; border-bottom: 1px solid var(--border-color); 
            display: flex; justify-content: space-between; align-items: center; 
            background: #252525; min-height: 60px;
        }
        .my-profile { font-weight: bold; color: var(--primary-color); font-size: 14px; }
        
        .sidebar-section-label { 
            padding: 20px 15px 10px 15px; font-size: 11px; 
            text-transform: uppercase; color: var(--text-secondary); 
            font-weight: 800; letter-spacing: 1.5px; 
        }
        
        #user-list { flex: 1; overflow-y: auto; }
        .user-item { 
            padding: 14px 15px; border-bottom: 1px solid #252525; 
            cursor: pointer; display: flex; align-items: center; 
            transition: 0.2s; 
        }
        .user-item:hover, .user-item.active { background: #2a2a2a; border-left: 4px solid var(--primary-color); }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 12px; }
        .status-online { background: var(--online-color); box-shadow: 0 0 8px var(--online-color); }
        .status-offline { background: var(--offline-color); }
        
        #chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-color); width: 100%; }
        .chat-header { padding: 0 15px; background: var(--surface-color); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; height: 60px; }
        
        .menu-toggle { display: none; background: transparent; border: none; color: white; font-size: 24px; cursor: pointer; margin-right: 15px; }

        .current-room-info { display: flex; flex-direction: column; }
        .current-room-name { font-weight: bold; font-size: 16px; }
        .current-room-status { font-size: 11px; color: var(--online-color); }
        
        #messages-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .message { max-width: 85%; padding: 12px 16px; border-radius: 18px; font-size: 15px; line-height: 1.5; position: relative; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background: var(--msg-sent); color: white; border-bottom-right-radius: 4px; }
        .message.received { align-self: flex-start; background: var(--msg-received); color: var(--text-primary); border-bottom-left-radius: 4px; }
        .msg-sender-name { font-size: 11px; font-weight: bold; margin-bottom: 4px; color: #93c5fd; }
        .msg-time { font-size: 9px; float: right; margin-top: 8px; margin-left: 10px; opacity: 0.6; }

        .input-area { padding: 15px; background: var(--surface-color); border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; }
        #msg-input { flex: 1; padding: 14px 20px; border-radius: 25px; background: #2a2a2a; border: 1px solid #333; color: white; font-size: 15px; }
        #send-btn { width: 48px; height: 48px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; border: none; cursor: pointer; flex-shrink: 0; }

        /* Mobile */
        @media (max-width: 768px) {
            .menu-toggle { display: block; }
            #sidebar { position: fixed; top: 0; left: 0; height: 100%; width: 280px; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
            #sidebar.active { transform: translateX(0); }
            #sidebar-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 90; }
            #sidebar-overlay.active { display: block; }
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="sidebar-overlay"></div>

    <div id="auth-screen">
        <div class="auth-box">
            <h2 id="auth-title">Login Chat</h2>
            <p id="conn-status" style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">Menghubungkan...</p>
            <input type="text" id="username" placeholder="Username" autocomplete="off">
            <input type="password" id="password" placeholder="Password">
            <button id="auth-btn" disabled>Tunggu Sebentar...</button>
            <p id="toggle-auth-text" style="margin-top:20px; cursor:pointer; text-decoration:underline; font-size:14px;">Buat akun baru</p>
        </div>
    </div>

    <div id="app-screen">
        <div id="sidebar">
            <div class="sidebar-header">
                <span class="my-profile" id="my-username">...</span>
                <button id="logout-btn" style="background:#dc2626; color:white; border:none; padding:5px 10px; border-radius:4px; font-size:11px; cursor:pointer;">Keluar</button>
            </div>
            
            <div class="sidebar-section-label">Grup</div>
            <div id="global-room-item" class="user-item active">
                <div class="status-dot" style="background: #3b82f6;"></div>
                <div class="user-info">
                    <div class="user-name">GLOBAL CHAT</div>
                    <div class="user-last-seen">Publik</div>
                </div>
            </div>

            <div class="sidebar-section-label">Private Chat</div>
            <div id="user-list"></div>
        </div>

        <div id="chat-area">
            <div class="chat-header">
                <button class="menu-toggle" id="menu-btn">â˜°</button>
                <div class="current-room-info">
                    <span class="current-room-name" id="room-title">Global Room</span>
                    <span class="current-room-status" id="room-status">Public Group</span>
                </div>
            </div>
            
            <div id="messages-container"></div>
            
            <div class="input-area">
                <input type="text" id="msg-input" placeholder="Tulis pesan..." autocomplete="off">
                <button id="send-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getFirestore, collection, doc, setDoc, getDoc, updateDoc, 
            addDoc, query, orderBy, onSnapshot, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
          apiKey: "AIzaSyCF6VsawNScXC8vQuqqFtVK9dqnwIiN5Us",
          authDomain: "vidcall-c5202.firebaseapp.com",
          databaseURL: "https://vidcall-c5202-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "vidcall-c5202",
          storageBucket: "vidcall-c5202.firebasestorage.app",
          messagingSenderId: "1088851390418",
          appId: "1:1088851390418:web:cb2a3214ff94435f82e20b"
        };

        const appId = "vidcall-responsive-v2"; 
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let currentUser = null;
        let currentRoomId = 'global';
        let currentChatPartner = null;
        let isRegisterMode = false;
        let unsubscribeMessages = null;

        // --- DOM Elements ---
        const authBtn = document.getElementById('auth-btn');
        const authTitle = document.getElementById('auth-title');
        const toggleAuthText = document.getElementById('toggle-auth-text');
        const connStatus = document.getElementById('conn-status');
        const msgInput = document.getElementById('msg-input');
        const messagesContainer = document.getElementById('messages-container');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebar-overlay');

        // Firestore Path Helpers
        const getColl = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const getDocRef = (name, id) => doc(db, 'artifacts', appId, 'public', 'data', name, id);

        // --- functions registered to window for safety ---
        window.toggleSidebar = () => {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        };

        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            authTitle.innerText = isRegisterMode ? "Daftar Akun" : "Login Chat";
            authBtn.innerText = isRegisterMode ? "Daftar" : "Masuk";
            toggleAuthText.innerText = isRegisterMode ? "Sudah punya akun? Login" : "Buat akun baru";
        };

        window.handleAuth = async () => {
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value.trim();
            if (!username || !password) return alert("Harap isi username dan password!");
            
            authBtn.disabled = true;
            authBtn.innerText = "Memproses...";

            try {
                const userRef = getDocRef("users", username);
                const userSnap = await getDoc(userRef);

                if (isRegisterMode) {
                    if (userSnap.exists()) {
                        alert("Username sudah terpakai!");
                    } else {
                        await setDoc(userRef, { password, online: true, lastSeen: serverTimestamp() });
                        loginUser(username);
                    }
                } else {
                    if (userSnap.exists() && userSnap.data().password === password) {
                        await updateDoc(userRef, { online: true });
                        loginUser(username);
                    } else {
                        alert("Username atau Password salah!");
                    }
                }
            } catch (e) { 
                console.error(e);
                alert("Gagal terhubung ke database!"); 
            }
            authBtn.disabled = false;
            authBtn.innerText = isRegisterMode ? "Daftar" : "Masuk";
        };

        function loginUser(username) {
            currentUser = username;
            localStorage.setItem('chat_user_v2', username);
            document.getElementById('my-username').innerText = `@${username}`;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').style.display = 'flex';
            listenUsers();
            selectRoom('global');
        }

        window.logout = async () => {
            if (currentUser) {
                try { await updateDoc(getDocRef("users", currentUser), { online: false }); } catch(e){}
            }
            localStorage.removeItem('chat_user_v2');
            location.reload();
        };

        function listenUsers() {
            onSnapshot(getColl("users"), (snap) => {
                const list = document.getElementById('user-list');
                list.innerHTML = '';
                snap.forEach(d => {
                    if (d.id === currentUser) return;
                    const data = d.data();
                    const el = document.createElement('div');
                    el.className = `user-item ${currentChatPartner === d.id ? 'active' : ''}`;
                    el.onclick = () => selectRoom(d.id);
                    el.innerHTML = `
                        <div class="status-dot ${data.online ? 'status-online' : 'status-offline'}"></div>
                        <div class="user-info">
                            <div class="user-name">${d.id}</div>
                            <div class="user-last-seen">${data.online ? 'Online' : 'Offline'}</div>
                        </div>`;
                    list.appendChild(el);
                });
            });
        }

        window.selectRoom = (target) => {
            if (unsubscribeMessages) unsubscribeMessages();
            
            document.querySelectorAll('.user-item').forEach(e => e.classList.remove('active'));
            
            if (target === 'global') {
                currentChatPartner = null;
                currentRoomId = 'global';
                document.getElementById('global-room-item').classList.add('active');
                document.getElementById('room-title').innerText = "GLOBAL CHAT";
                document.getElementById('room-status').innerText = "Public Group";
            } else {
                currentChatPartner = target;
                currentRoomId = [currentUser, target].sort().join('___');
                document.getElementById('global-room-item').classList.remove('active');
                document.getElementById('room-title').innerText = target;
                document.getElementById('room-status').innerText = "Private Chat";
            }
            
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
            }

            listenMessages();
        };

        function listenMessages() {
            const path = currentChatPartner ? `private_rooms/${currentRoomId}/messages` : `global_messages`;
            const q = query(getColl(path), orderBy("time", "asc"));
            
            unsubscribeMessages = onSnapshot(q, (snap) => {
                messagesContainer.innerHTML = '';
                snap.forEach(d => {
                    const data = d.data();
                    const isMe = data.user === currentUser;
                    const time = data.time ? new Date(data.time.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                    const div = document.createElement('div');
                    div.className = `message ${isMe ? 'sent' : 'received'}`;
                    div.innerHTML = `
                        ${!isMe && !currentChatPartner ? `<span class="msg-sender-name">${data.user}</span>` : ''}
                        ${data.text}
                        <span class="msg-time">${time}</span>`;
                    messagesContainer.appendChild(div);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        window.sendMessage = async () => {
            const text = msgInput.value.trim();
            if (!text) return;
            msgInput.value = '';
            const path = currentChatPartner ? `private_rooms/${currentRoomId}/messages` : `global_messages`;
            try {
                await addDoc(getColl(path), { user: currentUser, text, time: serverTimestamp() });
            } catch (e) { console.error(e); }
        };

        // --- Event Listeners ---
        authBtn.addEventListener('click', window.handleAuth);
        toggleAuthText.addEventListener('click', window.toggleAuthMode);
        document.getElementById('logout-btn').addEventListener('click', window.logout);
        document.getElementById('menu-btn').addEventListener('click', window.toggleSidebar);
        overlay.addEventListener('click', window.toggleSidebar);
        document.getElementById('global-room-item').addEventListener('click', () => window.selectRoom('global'));
        document.getElementById('send-btn').addEventListener('click', window.sendMessage);
        msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') window.sendMessage(); });

        // --- Initial Load ---
        const saved = localStorage.getItem('chat_user_v2');
        if (saved) {
            loginUser(saved);
        } else {
            connStatus.innerText = "Sistem Online";
            connStatus.style.color = "#10b981";
            authBtn.disabled = false;
            authBtn.innerText = "Masuk";
        }
    </script>
</body>
</html>
