<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dark Realtime Chat</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #3b82f6;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --msg-sent: #2563eb;
            --msg-received: #333333;
            --border-color: #333;
            --online-color: #10b981;
            --offline-color: #6b7280;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 3px; }

        /* --- Auth Screen --- */
        #auth-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 100; display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px; transition: opacity 0.3s; }
        .auth-box { width: 100%; max-width: 320px; background: var(--surface-color); padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.5); text-align: center; }
        .auth-box h2 { margin-bottom: 20px; color: var(--primary-color); }
        input { width: 100%; padding: 12px; margin: 8px 0; background: #2c2c2c; border: 1px solid var(--border-color); color: white; border-radius: 6px; font-size: 16px; }
        input:focus { border-color: var(--primary-color); }
        button { width: 100%; padding: 12px; margin-top: 15px; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: background 0.2s; }
        button:active { transform: scale(0.98); opacity: 0.9; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        .toggle-auth { margin-top: 15px; font-size: 14px; color: var(--text-secondary); cursor: pointer; text-decoration: underline; }

        /* --- Main App Layout --- */
        #app-screen { display: none; width: 100%; height: 100%; flex-direction: row; }
        
        #sidebar { width: 300px; background: var(--surface-color); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; transition: transform 0.3s ease; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; background: #252525; }
        .my-profile { font-weight: bold; color: var(--primary-color); font-size: 14px; }
        
        .sidebar-section-label { padding: 15px 15px 5px 15px; font-size: 12px; text-transform: uppercase; color: var(--text-secondary); font-weight: bold; letter-spacing: 1px; }
        
        #user-list { flex: 1; overflow-y: auto; }
        .user-item { padding: 12px 15px; border-bottom: 1px solid #2a2a2a; cursor: pointer; display: flex; align-items: center; transition: background 0.2s; }
        .user-item:hover, .user-item.active { background: #2a2a2a; border-left: 3px solid var(--primary-color); }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; margin-right: 10px; flex-shrink: 0; }
        .status-online { background: var(--online-color); box-shadow: 0 0 5px var(--online-color); }
        .status-offline { background: var(--offline-color); }
        .user-info { flex: 1; overflow: hidden; }
        .user-name { font-size: 15px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .user-last-seen { font-size: 11px; color: var(--text-secondary); }

        #chat-area { flex: 1; display: flex; flex-direction: column; background: var(--bg-color); position: relative; }
        .chat-header { padding: 10px 15px; background: var(--surface-color); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; height: 60px; }
        .back-btn { display: none; margin-right: 10px; background: transparent; color: var(--text-primary); width: auto; padding: 5px; font-size: 20px; border: none; cursor: pointer; }
        .current-room-info { display: flex; flex-direction: column; }
        .current-room-name { font-weight: bold; font-size: 16px; }
        .current-room-status { font-size: 12px; color: var(--online-color); }
        
        #messages-container { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Message Bubbles */
        .message { max-width: 75%; padding: 10px 14px; border-radius: 12px; font-size: 14px; line-height: 1.4; position: relative; word-wrap: break-word; animation: fadeIn 0.2s ease; }
        .message.sent { align-self: flex-end; background: var(--msg-sent); color: white; border-bottom-right-radius: 2px; }
        .message.received { align-self: flex-start; background: var(--msg-received); color: var(--text-primary); border-bottom-left-radius: 2px; }
        .msg-sender-name { font-size: 11px; font-weight: bold; margin-bottom: 3px; display: block; color: #93c5fd; }
        .msg-time { font-size: 10px; float: right; margin-top: 6px; margin-left: 8px; opacity: 0.6; }

        .input-area { padding: 10px; background: var(--surface-color); border-top: 1px solid var(--border-color); display: flex; align-items: center; gap: 10px; }
        #msg-input { flex: 1; padding: 12px; border-radius: 20px; background: #2c2c2c; border: none; color: white; }
        #send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary-color); display: flex; align-items: center; justify-content: center; padding: 0; margin: 0; border: none; cursor: pointer; }
        #send-btn svg { width: 20px; height: 20px; fill: white; }

        @media (max-width: 768px) {
            #sidebar { position: absolute; width: 100%; height: 100%; z-index: 50; transform: translateX(0); }
            #sidebar.hidden { transform: translateX(-100%); }
            .back-btn { display: block; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <!-- AUTH SCREEN -->
    <div id="auth-screen">
        <div class="auth-box">
            <h2 id="auth-title">Login Chat</h2>
            <p id="conn-status" style="font-size: 12px; color: var(--text-secondary); margin-bottom: 10px;">Menghubungkan ke database...</p>
            <input type="text" id="username" placeholder="Username (tanpa spasi)" autocomplete="off">
            <input type="password" id="password" placeholder="Password">
            <button id="auth-btn" onclick="handleAuth()">Login</button>
            <p class="toggle-auth" onclick="toggleAuthMode()">Belum punya akun? Register</p>
        </div>
    </div>

    <!-- MAIN APP SCREEN -->
    <div id="app-screen">
        <div id="sidebar">
            <div class="sidebar-header">
                <span class="my-profile" id="my-username">...</span>
                <button onclick="logout()" style="width: auto; padding: 5px 10px; font-size: 12px; margin: 0; background: #dc2626; border: none; color: white; border-radius: 4px;">Logout</button>
            </div>
            
            <div class="sidebar-section-label">Grup</div>
            <div id="global-room-item" class="user-item active" onclick="selectRoom('global')">
                <div class="status-dot" style="background: #3b82f6;"></div>
                <div class="user-info">
                    <div class="user-name">GLOBAL CHAT</div>
                    <div class="user-last-seen">Semua orang ada di sini</div>
                </div>
            </div>

            <div class="sidebar-section-label">Teman (Private Chat)</div>
            <div id="user-list">
                <!-- Daftar user lain akan muncul di sini -->
            </div>
        </div>

        <div id="chat-area">
            <div class="chat-header">
                <button class="back-btn" onclick="showSidebar()">‚Üê</button>
                <div class="current-room-info">
                    <span class="current-room-name" id="room-title">Global Room</span>
                    <span class="current-room-status" id="room-status">Public Group</span>
                </div>
            </div>
            <div id="messages-container"></div>
            <div class="input-area">
                <input type="text" id="msg-input" placeholder="Ketik pesan..." onkeypress="if(event.key==='Enter') sendMessage()">
                <button id="send-btn" onclick="sendMessage()">
                    <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
                </button>
            </div>
        </div>
    </div>

    <!-- FIREBASE MODULES -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { 
            getFirestore, collection, doc, setDoc, getDoc, updateDoc, 
            addDoc, query, orderBy, onSnapshot, serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // ==========================================
        // KONFIGURASI FIREBASE
        // ==========================================
        const firebaseConfig = {
          apiKey: "AIzaSyCF6VsawNScXC8vQuqqFtVK9dqnwIiN5Us",
          authDomain: "vidcall-c5202.firebaseapp.com",
          databaseURL: "https://vidcall-c5202-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "vidcall-c5202",
          storageBucket: "vidcall-c5202.firebasestorage.app",
          messagingSenderId: "1088851390418",
          appId: "1:1088851390418:web:cb2a3214ff94435f82e20b"
        };

        const appId = "vidcall-v2-system"; 
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- STATE ---
        let currentUser = null;
        let currentRoomId = 'global';
        let currentChatPartner = null;
        let isRegisterMode = false;
        
        let unsubscribeMessages = null;
        let unsubscribeUsers = null;

        const authBtn = document.getElementById('auth-btn');
        const connStatus = document.getElementById('conn-status');
        const msgInput = document.getElementById('msg-input');
        const messagesContainer = document.getElementById('messages-container');

        // Firestore Path Helpers
        const getColl = (name) => collection(db, 'artifacts', appId, 'public', 'data', name);
        const getDocRef = (name, id) => doc(db, 'artifacts', appId, 'public', 'data', name, id);

        // ==========================================
        // INITIALIZE
        // ==========================================
        function startApp() {
            connStatus.innerText = "Sistem Siap";
            connStatus.style.color = "#10b981";
            
            authBtn.disabled = false;
            const savedUser = localStorage.getItem('chat_v6_user');
            if (savedUser) loginUser(savedUser);
        }

        startApp();

        window.toggleAuthMode = () => {
            isRegisterMode = !isRegisterMode;
            document.getElementById('auth-title').innerText = isRegisterMode ? "Daftar Akun" : "Login Chat";
            authBtn.innerText = isRegisterMode ? "Daftar" : "Login";
            document.querySelector('.toggle-auth').innerText = isRegisterMode ? "Sudah punya akun? Login" : "Belum punya akun? Register";
        };

        window.handleAuth = async () => {
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value.trim();

            if (!username || !password) return alert("Harap isi username dan password!");
            if (username === 'global') return alert("Username 'global' dilarang.");
            authBtn.disabled = true;

            try {
                const userRef = getDocRef("users", username);
                const userSnap = await getDoc(userRef);

                if (isRegisterMode) {
                    if (userSnap.exists()) {
                        alert("Username ini sudah dipakai orang lain.");
                    } else {
                        await setDoc(userRef, { password, online: true, lastSeen: serverTimestamp() });
                        loginUser(username);
                    }
                } else {
                    if (userSnap.exists() && userSnap.data().password === password) {
                        await updateDoc(userRef, { online: true, lastSeen: serverTimestamp() });
                        loginUser(username);
                    } else {
                        alert("Username atau Password salah!");
                    }
                }
            } catch (e) {
                console.error(e);
                alert("Koneksi bermasalah. Pastikan Firestore Rules kamu di Console sudah 'allow read, write: if true;'");
            } finally {
                authBtn.disabled = false;
            }
        };

        function loginUser(username) {
            currentUser = username;
            localStorage.setItem('chat_v6_user', username);
            document.getElementById('my-username').innerText = `@${username}`;
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('app-screen').style.display = 'flex';
            initChat();
        }

        window.logout = async () => {
            if (currentUser) {
                try { await updateDoc(getDocRef("users", currentUser), { online: false }); } catch(e){}
            }
            localStorage.removeItem('chat_v6_user');
            location.reload();
        };

        // ==========================================
        // USER LIST LOGIC
        // ==========================================
        function initChat() {
            listenUsers();
            selectRoom('global');
        }

        function listenUsers() {
            if (unsubscribeUsers) unsubscribeUsers();
            unsubscribeUsers = onSnapshot(getColl("users"), (snapshot) => {
                const listEl = document.getElementById('user-list');
                listEl.innerHTML = ``;

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const userId = docSnap.id;
                    if (userId === currentUser) return;

                    const item = document.createElement('div');
                    item.className = `user-item ${currentChatPartner === userId ? 'active' : ''}`;
                    item.id = `user-item-${userId}`;
                    item.onclick = () => selectRoom(userId);
                    item.innerHTML = `
                        <div class="status-dot ${data.online ? 'status-online' : 'status-offline'}"></div>
                        <div class="user-info">
                            <div class="user-name">${userId}</div>
                            <div class="user-last-seen">${data.online ? 'Sedang Online' : 'Offline'}</div>
                        </div>`;
                    listEl.appendChild(item);
                });
            });
        }

        // ==========================================
        // ROOM SELECTION (GLOBAL vs PRIVATE)
        // ==========================================
        window.selectRoom = (target) => {
            if (unsubscribeMessages) unsubscribeMessages();
            
            // UI Cleanup
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
            document.getElementById('global-room-item').classList.remove('active');

            if (target === 'global') {
                currentRoomId = 'global';
                currentChatPartner = null;
                document.getElementById('global-room-item').classList.add('active');
                document.getElementById('room-title').innerText = "GLOBAL CHAT";
                document.getElementById('room-status').innerText = "Public Group";
                document.getElementById('room-status').style.color = "var(--text-secondary)";
            } else {
                // Private Chat ID: Menggabungkan 2 username secara alfabetis agar ID konsisten bagi kedua user
                currentRoomId = [currentUser, target].sort().join('___');
                currentChatPartner = target;
                document.getElementById(`user-item-${target}`).classList.add('active');
                document.getElementById('room-title').innerText = `Chat dengan ${target}`;
                document.getElementById('room-status').innerText = "Private Chat (End-to-End)";
                document.getElementById('room-status').style.color = "var(--online-color)";
            }

            if (window.innerWidth <= 768) document.getElementById('sidebar').classList.add('hidden');
            listenMessages();
        };

        window.showSidebar = () => document.getElementById('sidebar').classList.remove('hidden');

        // ==========================================
        // MESSAGE LISTENER
        // ==========================================
        function listenMessages() {
            messagesContainer.innerHTML = '';
            // Tentukan koleksi berdasarkan apakah ini private atau global
            const collName = currentChatPartner ? `private_rooms/${currentRoomId}/messages` : `global_messages`;
            const q = query(getColl(collName), orderBy("time", "asc"));

            unsubscribeMessages = onSnapshot(q, (snapshot) => {
                messagesContainer.innerHTML = '';
                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const isMe = data.user === currentUser;
                    const time = data.time ? new Date(data.time.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                    
                    const div = document.createElement('div');
                    div.className = `message ${isMe ? 'sent' : 'received'}`;
                    
                    let senderName = '';
                    if (!isMe && !currentChatPartner) {
                        senderName = `<span class="msg-sender-name">${data.user}</span>`;
                    }

                    div.innerHTML = `
                        ${senderName}
                        ${data.text}
                        <span class="msg-time">${time}</span>`;
                    messagesContainer.appendChild(div);
                });
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }

        // ==========================================
        // SEND MESSAGE
        // ==========================================
        window.sendMessage = async () => {
            const text = msgInput.value.trim();
            if (!text) return;
            msgInput.value = '';

            const collName = currentChatPartner ? `private_rooms/${currentRoomId}/messages` : `global_messages`;
            try {
                await addDoc(getColl(collName), { 
                    user: currentUser, 
                    text: text, 
                    time: serverTimestamp() 
                });
            } catch (e) { 
                console.error(e);
                alert("Gagal kirim pesan. Pastikan Rules Firestore kamu sudah benar."); 
            }
        };
    </script>
</body>
</html>
